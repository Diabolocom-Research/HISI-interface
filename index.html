<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://unpkg.com/wavesurfer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://kit.fontawesome.com/02ee14764b.js?v=4" crossorigin="anonymous"></script>
    <link href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
    <script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whisper Transcription: Configure Model</title>
    <link rel="stylesheet" href="/static/scripts/style.css?v=3">
</head>
<body>

    <div id="view-model-selection">
        <h1>Configure ASR Engine</h1>
        <label for="config-json">ASR Engine Parameters (JSON):</label>
        <textarea id="config-json" class="config-json" rows="10"></textarea>
        <button id="load-model-button">Load Engine and Start</button>
    </div>

    <div id="view-loading" class="view-hidden">
        <div class="spinner"></div><h2>Loading ASR Engine...</h2>
        <p>This may take a moment, especially on the first run.</p>
    </div>

    <div id="view-transcription" class="view-hidden"> 
        <div class="container">

            <div class="tabs">
                <button class="tab-button active" data-tab="record">Record Audio</button>
                <button class="tab-button" data-tab="upload">Upload Audio File</button>
                <button class="tab-button" data-tab="metrics">Evaluation Metrics</button>
            </div>

            <!-- Modal for editing timeline item -->
            <div id="timeline-edit-modal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:1000; align-items:center; justify-content:center;">
                <div style="background:#fff; padding:20px; border-radius:8px; min-width:300px; width: 30%; gap: 12px; display: flex; flex-direction: column;">
                    <h3 style="margin: 0;">Edit Segment</h3>
                    <label style="width: 95%;">Text:
                    <input type="text" id="timeline-edit-text" style="width:100%; margin-top: 8px;     border: 1px solid var(--border-light); border-radius: 4px; padding: 4px 7px;">
                    </label>
                    <label style="width: 95%;">Start (seconds):
                    <input type="number" id="timeline-edit-start" step="0.01" style="width:100%; margin-top: 8px;  border: 1px solid var(--border-light);    border-radius: 4px; padding: 4px 7px;">
                    </label>
                    <label style="width: 95%;">End (seconds):
                    <input type="number" id="timeline-edit-end" step="0.01" style="width:100%; margin-top: 8px;  border: 1px solid var(--border-light);    padding: 4px 7px; padding: 4px 7px;">
                    </label>
                    <div style="display: flex; gap: 8px;">
                        <button id="timeline-edit-save" style="flex: 1 1 50%; border: 1px solid var(--border-light);    padding: 4px 7px; padding: 4px 7px;">Save</button>
                        <button id="timeline-edit-cancel" style="flex: 1 1 50%; border: 1px solid var(--border-light);    padding: 4px 7px; padding: 4px 7px;">Cancel</button>
                    </div>
                </div>
            </div>

            <div id="record" class="tab-content active">
                <div class="container">

                    <!-- Recording Waveform Container -->
                    <div class="waveform-container-new-recording">
                        <div id="no-recording-message" class="no-recording-message">
                            <img src="static/assets/speaker_black_icon_48.png" alt="speaker" style="width: 58px; margin-bottom: 8px;">
                            <p>No recording started</p>
                            <p>Press "Start Recording" to preview the waveform</p>
                        </div>

                        <div id="mic" style="border-radius: 4px; min-height: 100px; display: none; height: calc(100% - 40px); max-height: 222px; width: 100%;"></div>
                        
                        <div class="controls-audio-upload">
                            <div id="start-button" style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-left: 10px;">
                                <img src="static/assets/microphone_icon.png" style="width: 18px;" alt="microphone" class="microphone-icon">
                                <p class="start-button-txt" style="margin: 0; font-size: 14px;">Start Recording</p>
                            </div>

                            <div class="left_controls">
                                <div id="recording-status" style="display: none; align-items: center; justify-content: center; gap: 8px; color: #333; font-family: monospace; font-size: 14px;">
                                    <div class="recording-dot"></div>
                                    <span id="recording-timer">00:00</span>
                                </div>
                            </div>

                            <div class="right_controls">
                                <div class="img_container" id="reset-recording-btn-container" style="display: none;">
                                    <img src="/static/assets/reload_black_icon_48.png" style="width: 18px; height: 18px;" id="reset-recording-btn-icon" alt="reset">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Transcript Box -->
                    <div class="waveform-container">
                        <p class="badge">Transcript</p>
                        <div class="transcript-container" id="transcript-container">
                            <p id="transcript-text">Speak to see transcript...</p>
                        </div>
                    </div>

                    <!-- Playback Waveform Container -->
                    <div class="waveform-container-new">
                        <div id="recordings" style="margin-top: 1em; height: calc(100% - 40px); max-height: 222px;"></div>

                        <div class="controls-audio-upload">
                            <div class="left_controls">
                                <div class="img_container" id="play-mic-recording-container">
                                    <img src="/static/assets/play_black_icon_48.png" id="play-mic-recording" class="play_btn" alt="play">
                                </div>

                                <div class="img_container speaker-recording">
                                    <img src="/static/assets/mute_black_icon_48.png" alt="speaker">
                                </div>
                            </div>

                            <div class="right_controls">
                                <div class="img_container">
                                    <p id="progress" class="audio_duration">00:00:00</p>
                                </div>
                                <div class="total_duration_container">
                                    <p class="total_audio_duration_record">00:00:00</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Timeline Container -->
                    <div class="waveform-container">
                        <p class="badge">Timeline</p>
                        <div id="transcript-timeline" style="margin-top: 2em;"></div>
                    </div>

                    <!-- Segments Table Container -->
                    <div class="segments-table-container">
                        <div class="table-wrapper">
                            <table class="segments-table" id="segments-table-recording">
                                <thead>
                                    <tr>
                                        <th>Start Time</th>
                                        <th>End Time</th>
                                        <th>Duration</th>
                                        <th>Text/Content</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="segments-table-body-recording">
                                    <!-- Segments will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                </div>
            </div>

           <div id="metrics" class="tab-content">
                <div class="container">
                    <form id="eval-form">
                        <div class="form-group">
                            <label for="audio" style="font-weight: 500;">Select audio file for evaluation:</label>
                            
                            <!-- Enhanced File Upload Area -->
                            <div class="file-upload-area" id="file-upload-area">
                                <div class="upload-content">
                                    <i class="fa-solid fa-cloud-arrow-up upload-icon"></i>
                                    <h3>Drag & drop your audio file here</h3>
                                    <p>or click to browse files</p>
                                    <span class="file-types">Supported: MP3, WAV, M4A, FLAC</span>
                                </div>
                                <input type="file" name="audio" id="audio" class="audio-evaluation" accept="audio/*" required>
                            </div>
                            
                            <!-- Selected File Display -->
                            <div id="selected-file-display" class="selected-file-display" style="display:none;">
                                <div class="file-info">
                                    <i class="fa-solid fa-file-audio file-icon"></i>
                                    <div class="file-details">
                                        <span class="filename" id="selected-filename"></span>
                                        <span class="file-size" id="selected-filesize"></span>
                                    </div>
                                </div>
                                <button type="button" id="remove-file-btn" class="remove-btn" title="Remove file">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 2em;">
                            <label style="font-weight: 500;" for="reference">Reference transcript:</label>
                            <div class="textarea-wrapper">
                                <textarea name="reference" id="reference" class="reference-textarea" placeholder="Enter the expected transcript" required rows="4"></textarea>
                            </div>
                        </div>
                        
                        <button disabled type="submit" id="evaluation-btn" class="evaluation-btn">
                            <i class="fa-solid fa-chart-line"></i>
                            Run Evaluation
                        </button>
                    </form>

                    <div class="results-section">
                        <p style="font-weight: 500; padding-left: 2px;">Evaluation Results:</p>
                        <div id="metrics_div" class="metrics-container"></div>
                    </div>
                </div>
            </div>

            <div id="upload" class="tab-content">
                <div class="container">
                    <!-- Playback Waveform Container -->
                    <div class="waveform-container-new"> 
                                                
                        <div id="no-file-message" class="no-file-message">
                            <img src="/static/assets/file_black_icon_96.png" alt="file" style="width: 68px; margin-bottom: 10px;">
                            <p>No audio file selected</p>
                            <p>Upload an audio file to preview the waveform</p>
                        </div>

                        <div id="waveform" style="margin-top: 1em; display: none;" ></div>
                        
                        <div class="controls-audio-upload">
                                <div class="img_container" style="margin-left: 10px;">
                                    <label for="audio_file" class="custom-file-upload">
                                        <img src="/static/assets/upload_black_icon_48.png" style="width: 18px; height: 18px;" alt="upload">
                                    </label>
                                    <input type="file" name="audio_file" id="audio_file" accept="audio/*" required style="display: none;">      
                                </div>
                                <div class="img_container" style="margin-left: 2px;">
                                    <img src="/static/assets/reload_black_icon_48.png" style="width: 18px; height: 18px;" id="resetDataBtn" alt="">
                                </div>

                                <div class="left_controls">
                                    <div class="img_container" id="play-upload-recording-container">
                                        <img src="/static/assets/play_black_icon_48.png" id="play-upload-recording" alt="play">
                                    </div>

                                    <div class="img_container speaker">
                                        <img src="/static/assets/mute_black_icon_48.png" alt="speaker">
                                    </div>
                                </div>

                                <div class="right_controls">
                                    <div class="img_container">
                                        <p class="zoom_level">0.5x</p>
                                    </div>
                                    <div class="img_container">
                                        <p id="progress_upload" class="current_duration">00:00:00</p>
                                    </div>
                                    <div class="total_duration_container">
                                        <p class="total_audio_duration">00:00:00</p>
                                    </div>
                                </div>
                            </div>
                    </div>

                    <button id="start-trasncript-btn" type="submit" disabled>Start Transcription</button>
                    
                    <!-- Timeline Container -->
                    <div class="waveform-container">
                        <p class="badge">Timeline</p>
                        <div id="transcript-timeline-upload" style="margin: 2em 0; margin-bottom: 0;"></div>
                    </div>

                    <!-- Transcript Box -->
                    <div class="waveform-container">
                        <p class="badge">Transcript</p>
                        <div class="transcript-container" id="transcript-container">
                            <p id="output">Upload a file to see transcript...</p>
                        </div>
                    </div>

                    <div class="segments-table-container">
                        <div class="table-wrapper">
                            <table class="segments-table" id="segments-table-upload">
                                <thead>
                                    <tr>
                                        <th>Start Time</th>
                                        <th>End Time</th>
                                        <th>Duration</th>
                                        <th>Text/Content</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="segments-table-body-upload">
                                    <!-- Segments will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Script for managing audio recording -->
    <script src="/static/scripts/audio_recording_script.js?v=4"></script>
    <!-- Script for managing audio file upload -->
    <script src="/static/scripts/audio_file_script.js?v=1" type="module"></script>
    <!-- Script for managing evaluation metrics -->
    <script src="/static/scripts/evaluation_script.js?v=2"></script>
    <!-- Script to manage wavesufer library -->
    <script src="/static/scripts/wavesurfers.js?v=2" type="module"></script>
    <script>
        window.RTC_CONFIGURATION = ##RTC_CONFIGURATION##;

        // --- NEW: TAB NAVIGATION LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const targetTab = button.dataset.tab;

                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        tabContents.forEach(content => content.classList.remove('active'));

                        button.classList.add('active');
                        document.getElementById(targetTab).classList.add('active');
                    });
                });
        });
    </script>
</body>
</html>