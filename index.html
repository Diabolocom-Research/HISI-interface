<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://unpkg.com/wavesurfer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://kit.fontawesome.com/02ee14764b.js" crossorigin="anonymous"></script>
    <link href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
    <script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whisper Transcription: Configure Model</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

    <div id="view-model-selection">
        <h1>Configure ASR Engine</h1>
        <label for="config-json">ASR Engine Parameters (JSON):</label>
        <textarea id="config-json" class="config-json" rows="10"></textarea>
        <button id="load-model-button">Load Engine and Start</button>
    </div>

    <div id="view-loading" class="view-hidden">
        <div class="spinner"></div><h2>Loading ASR Engine...</h2>
        <p>This may take a moment, especially on the first run.</p>
    </div>

    <div id="view-transcription" class="view-hidden">
        <div class="container">

            <div class="tabs">
                <button class="tab-button active" data-tab="record">Record Audio</button>
                <button class="tab-button" data-tab="upload">Upload Audio File</button>
                <button class="tab-button" data-tab="metrics">Evaluation Metrics</button>
            </div>

            <div id="record" class="tab-content active">
                <div class="container">

                    <!-- Recording Waveform Container -->
                    <div class="waveform-container">
                        <p class="badge">Click & Speak</p>
                        <p id="progress">00:00</p>
                        <div id="mic" style="border: 1px solid #ddd; border-radius: 4px; margin-top: 1rem"></div>
                        <div class="controls">
                            <div class="record-icon"></div>
                            <button id="start-button">Record</button>
                        </div>
                    </div>

                    <!-- Transcript Box -->
                    <div class="waveform-container">
                        <p class="badge">Transcript</p>
                        <div class="transcript-container" id="transcript-container">
                            <p id="transcript-text">Speak to see transcript...</p>
                        </div>
                    </div>

                    <!-- Playback Waveform Container -->
                    <div class="waveform-container">
                        <p class="badge">Playback</p>
                        <div id="recordings" style="margin: 1rem 0"></div>
                        <div class="controls">
                            <button id="play-mic-recording" class="play-recording" style="display: none;">
                                <i class="fa-solid fa-play"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Timeline Container -->
                    <div class="waveform-container">
                        <p class="badge">Timeline</p>
                        <div id="transcript-timeline" style="margin: 2em 0;"></div>
                    </div>

                    <!-- Table Container -->
                    <div class="waveform-container">
                        <p class="badge">Table</p>
                        <div class="table-container">
                            <table>
                                <thead><tr><th>Start (s)</th><th>End (s)</th><th>Text</th></tr></thead>
                                <tbody id="segments-table-body"></tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>

            <div id="metrics" class="tab-content">
                <div class="container">
                    <form id="eval-form">
                        <div class="form-group">
                            <div style="
                                display: flex;
                                gap: 12px;
                                align-items: center;
                            ">
                                <label for="audio">Select audio file:</label>
                                <div class="controls" id="custom-audio-upload" style="margin: 0;">
                                    <i class="fa-solid fa-arrow-up-from-bracket"></i>
                                    <input type="file" name="audio" id="audio" class="audio-evaluation" accept="audio/*" required>
                                </div>
                            </div>
                            <div id="selected-filename-container" style="display:none;">
                                <span id="selected-filename"></span>
                                <button type="button" id="remove-file-btn"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 2em;">
                            <label for="reference">Input reference transcript:</label>
                            <textarea name="reference" id="reference" class="config-json" placeholder="Reference transcript (e.g., 'Hello world')" required rows="4"></textarea>
                        </div>
                        <button disabled type="submit" id="evaluation-btn" class="custom-file-label">Run Evaluation</button>
                    </form>

                    <p style="font-weight: 400; margin-bottom: 0; margin-top: 2em;">Evaluation Results:</p>
                    <div id="metrics_div"></div>
                </div>
            </div>

            <div id="upload" class="tab-content">
                <div class="container">
                    <!-- Playback Waveform Container -->
                    <div class="waveform-container">
                        <p class="badge">Playback</p>
                        <p id="progress" class="audio_duration">00:00</p>

                        <div id="waveform" style="margin-top: 1em;"></div>

                        <div class="controls-container">
                            <div class="controls">
                                <label for="audio_file" class="custom-file-upload">
                                    <i class="fa-solid fa-arrow-up-from-bracket"></i>
                                </label>
                                <input type="file" name="audio_file" id="audio_file" accept="audio/*" required style="display: none;">
                            </div>

                            <div class="controls">
                                <button id="play-upload-recording" class="play-recording">
                                    <p class="custom_text">
                                        <i class="fa-solid fa-play"></i>
                                    </p>
                                </button>
                            </div>
                        </div>
                    </div>

                    <button id="start-trasncript-btn" type="submit" disabled>Start Transcription</button>

                    <!-- Transcript Box -->
                    <div class="waveform-container">
                        <p class="badge">Transcript</p>
                        <div class="transcript-container" id="transcript-container">
                            <p id="output">Upload a file to see transcript...</p>
                        </div>
                    </div>

                    <!-- Timeline Container -->
                    <div class="waveform-container">
                        <p class="badge">Timeline</p>
                        <div id="transcript-timeline-upload" style="margin: 2em 0;"></div>
                    </div>

                    <!-- Table Container -->
                    <div class="waveform-container">
                        <p class="badge">Table</p>
                         <div class="table-container">
                            <table>
                                <thead><tr><th>Start (s)</th><th>End (s)</th><th>Text</th></tr></thead>
                                <tbody id="segments-table-body-upload"></tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Script for managing audio recording -->
    <script src="/static/scripts/audio_recording_script.js"></script>
    <!-- Script for managing audio file upload -->
    <script src="/static/scripts/audio_file_script.js" type="module"></script>
    <!-- Script for managing evaluation metrics -->
    <script src="/static/scripts/evaluation_script.js"></script>
    <!-- Script to manage wavesufer library -->
    <script src="/static/scripts/wavesurfers.js" type="module"></script>
    <script>
        const audioInput = document.getElementById('audio_file');
        const startBtn = document.getElementById('start-trasncript-btn');

        audioInput.addEventListener('change', function() {
            // Enable button only if a file is selected
            startBtn.disabled = !audioInput.files.length;
        });

        window.RTC_CONFIGURATION = ##RTC_CONFIGURATION##;

        // --- NEW: TAB NAVIGATION LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const targetTab = button.dataset.tab;

                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        tabContents.forEach(content => content.classList.remove('active'));

                        button.classList.add('active');
                        document.getElementById(targetTab).classList.add('active');
                    });
                });
        });
    </script>
</body>
</html>